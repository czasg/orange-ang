---
title: 静态文件服务器
hide_title: false
hide_table_of_contents: false
slug: /file-server/static-file-server
---

import FullScreenImage from '@site/src/components/FullScreenImage';
import BrowserWindow from '@site/src/components/BrowserWindow';
import EmptyLine from '@site/src/components/EmptyLine';
import Tabs from '@theme/Tabs';
import TabItem from '@theme/TabItem';

<!--package-->

Nginx 搭建静态文件服务器，需要指定一个目录作为静态文件存储路径配置。我们假设有以下目录结构：

```text
/static
  ├── css
  │   └── custom.css
  ├── js
  │   ├── main.js
  │   └── custom.js
  ├── unknown.html
  ├── notfound.html
  └── index.html
```

在这个目录结构中，我们可以看到根目录`/static`下面存放了`html`、`js`、`css`等文件。为了更好的理解，我们假设每个文件的内容就是文件自身的详细路径~

这样我们就可以开始准备 nginx 配置文件了。

## root

在 nginx 中，`root`关键字可以指定一个目录作为静态文件存储路径配置。当请求命中路由规则时，会将**路径拼接在`root`路径之后去查找文件！**

为了更好的理解`root`的作用，我们假设定义了如下的路由规则：

```yaml
location / {
    root   /static;
}
```

当请求路径为`/static/css/custom.css`时，我们会发现 nginx 查找文件的路径为`/static/static/css/custom.css`！因此无法找到对应的文件。

所以我们需要调整请求路径为`/css/custom.css`，这时 nginx 就可以正确命中`/static/css/custom.css`文件。

大致了解`root`的原理之后，我们可以开始准备 nginx 配置文件。

### 1. 准备配置文件

```yaml title="/workspace/root.conf"
server {
    listen       80;
    server_name  _;

    # 静态文件服务器
    location / {
        # 指定根目录
        root   /static;
        # 指定默认返回的文件
        index  index.html;
    }
    # 文件不存在
    error_page  404  /notfound.html;
}
```

在上述配置中，我们可以看到定义了一个`location /`，表示所有的请求都会命中此规则。并且指定了根目录为`/static`，这样我们就可以将此目录映射到静态文件服务器中了。

:::note 补充
error_page 可以检测请求响应的错误码，从而实现内部转发能力。
:::

### 2. 启动服务

```bash
$ docker run -it --rm -p 80:80 \
    -v /workspace/root.conf:/etc/nginx/conf.d/default.conf \
    -v /static:/static \
    nginx
```

### 3. 功能验证

通过浏览器访问`http://localhost`，如果可以看到`index.html`页面，那就说明规则已经生效。

<BrowserWindow url="http://localhost/">

/static/index.html

</BrowserWindow>

通过浏览器访问`http://localhost/css/custom.css`，如果可以看到`custom.css`页面，那就说明规则已经生效。

<BrowserWindow url="http://localhost/css/custom.css">

/static/css/custom.css

</BrowserWindow>

通过浏览器访问`http://localhost/123`，这是一个不存在的页面，这时我们如果可以看到`notfound.html`页面，那就说明规则`error_page`已经生效。

<BrowserWindow url="http://localhost/123">

/static/notfound.html

</BrowserWindow>


## alias

在 nginx 中，`alias`和`root`一样可以指定服务器上静态文件的根目录。但他们之间有一些细微的差别，前者**不会拼接请求路径**，而后者会**拼接请求路径**！

同样为了更好的理解`alias`的作用，我们假设定义了如下的路由规则：

```yaml
location / {
    root   /static;
}
```

当请求路径为`/static/css/custom.css`时，我们会发现 nginx 查找文件的路径为`/static/css/custom.css`！这正好可以找到目标文件！

大致了解`alias`和`root`区别之后，我们可以开始准备 nginx 配置文件。

### 1. 准备配置文件

```yaml title="/workspace/alias.conf"
server {
    listen       80;
    server_name  _;

    # 静态文件服务器
    location / {
        # 指定根目录
        root   /static;
        # 指定默认返回的文件
        index  index.html;
    }
    # 文件不存在
    error_page  404  /notfound.html;
}
```

在上述配置中，我们可以看到定义了一个`location /`，表示所有的请求都会命中此规则。并且指定了根目录为`/static`，这样我们就可以将此目录映射到静态文件服务器中了。

### 2. 启动服务

```bash
$ docker run -it --rm -p 80:80 \
    -v /workspace/alias.conf:/etc/nginx/conf.d/default.conf \
    -v /static:/static \
    nginx
```

### 3. 功能验证

通过浏览器访问`http://localhost/`，如果可以看到`index.html`页面，那就说明规则已经生效。

<BrowserWindow url="http://localhost/">

    /static/index.html

</BrowserWindow>


## try_files

在 Nginx 中，`try_files`指令**用于尝试访问多个文件**，并根据访问结果返回对应的数据。

其语法结构为：

```text
try_files file1 [file2 ...] fallback;
```

其中我们可以看到`try_files`至少包含两个参数：

- `file1 [file2 ...]`：文件参数，表示待查找的的文件。
- `fallback`：默认参数，表示如果文件都无法找到，则使用此默认处理方式。

因此`try_files`可以单独生效，也可以结合`root`、`alias`一起使用。

现在让我们通过一个简单的示例来快速熟悉下`try_files`的使用。

### 1. 准备目录

我们假设有以下目录结构：

```text
/static2
  └── html
      └── index.html
```

### 2. 准备配置文件

并准备以下配置文件

```yaml title="/workspace/try_files.conf"
server {
    listen 80;
    server_name example.com;

    location / {
        root /static2;
        try_files $uri $uri/ =404;
    }
}
```

在上述配置中，我们可以看到`try_files`将依次查找：

- `$uri`：表示**文件路径**，指向某一个文件。
- `$uri/`：表示**目录路径**，指向某一个目录。
- `=404`：表示默认执行策略。当前两个都不存在时，则返回404错误。

### 3. 启动服务

```bash
$ docker run -it --rm -p 80:80 \
    -v /workspace/try_files.conf:/etc/nginx/conf.d/default.conf \
    -v /static2:/static2 \
    nginx
```

### 4. 功能验证

通过浏览器访问`http://localhost/html/`，如果可以看到`index.html`页面，那就说明规则已经生效。

<BrowserWindow url="http://localhost/html/">

    /static2/static2/index.html

</BrowserWindow>

我们可以简单分析下这个请求经历了什么：

1. 首先请求尝试查找`$uri`。这里一个文件路径，但`/static2/html`是一个目录，因此不匹配。
2. 然后请求尝试查找`$uri/`。这里一个目录路径，而`/static2/html/`确实是一个目录，因此尝试查找`index.html`文件。


## autoindex

在 Nginx 中，`autoindex`指令用于启动或禁止目录列表功能。

也就是，当我们启动了`autoindex`之后，我们就可以拥有一个在线文件浏览功能。这在调试和开发过程中非常有用，也可以用于提供文件下载服务。

通常来讲，`autoindex`指令可以在 `http`、`server`、`location` 块中使用。其语法结构为：

```text
autoindex on | off;
```

下面通过一个简单的示例来快速熟悉`autoindex`的使用~

### 1.配置准备

```yaml title="/workplace/autoindex.conf"
server {
    listen 80;
    server_name _;

    location / {
        root /workplace/static;
        autoindex on;
    }
}
```

在上述配置中，我们在`location`中指定了`autoindex on;`，表示启用目录列表功能。接着我们启动服务。

### 2.启动服务

```bash
$ docker run -it --rm -p 80:80 \
    -v /workspace/autoindex.conf:/etc/nginx/conf.d/default.conf \
    -v /static:/workplace/static \
    nginx
```

这个用例汇总，我们复用了`/static`目录。

### 3.功能验证

通过浏览器访问`http://localhost/`，如果可以看到文件目录列表页面，那就说明规则已经生效。

<BrowserWindow url="http://localhost/html/">

    Index of /images/
    Name         Last modified     Size
    ---------------------------------------
    Parent Directory    -
    banner.jpg   14-May-2024 10:10   4.5K
    logo.png     14-May-2024 10:10   2.3K

</BrowserWindow>
