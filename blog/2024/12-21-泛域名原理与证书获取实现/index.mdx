---
title: 泛域名原理与证书获取实现
authors: [czasg]
tags: [撰写中,待分类]
slug: 泛域名原理与证书获取实现
---

import FullScreenImage from '@site/src/components/FullScreenImage';

<!--package-->

随着互联网服务的多样化，越来越多的企业和开发者选择通过子域名和泛域名来简化域名管理和服务配置。泛域名允许一个通配符 `*` 替代子域名部分，从而匹配多个子域名。这种灵活性在多域名、云服务、微服务等架构中尤其重要。此外，多个域名共享一个 IP 地址时，正确的 SSL/TLS 证书获取和管理成为了一个技术挑战，尤其是在多个证书的服务器配置中，如何确保正确的证书被返回是一个关键问题。

<!--truncate-->

### **背景**

随着证书巡检系统的上线，我们逐渐发现了一些治理方面的问题，主要包括：

- 历史域名存在未维护的证书；
- 泛域名探测异常。

在上一次的分享讨论中，我们意识到泛域名证书探测的逻辑可能存在一些缺陷。为了深入理解和解决这一问题，我们整理了本文档，旨在探讨泛域名的原理及其证书获取实现的可行方案。

本报告旨在：
- 详细说明泛域名的原理，包括其如何与 DNS 解析机制协同工作。
- 探讨在存在多个证书的服务器上如何确保通过正确的 SNI 获取正确的证书。
- - 探讨泛域名证书获取方案。

### **泛域名原理**

#### 泛域名的定义

泛域名（Wildcard Domain）是指使用 `*` 通配符来表示域名的任意子域名。例如，`*.baidu.com` 表示所有以 `baidu.com` 为后缀的子域名（如 `www.baidu.com`、`mail.baidu.com`、`test.baidu.com` 等）都可以匹配到该泛域名。

#### 泛域名在 DNS 中的作用

- **DNS 解析**：在 DNS 解析过程中，当一个不存在的子域名（如 `123123123.baidu.com`）被请求时，若该域名符合配置的泛域名规则（如 `*.baidu.com`），DNS 会将请求解析到泛域名指定的 IP 地址。
- **优先级**：精确匹配优先。即如果 DNS 中有明确的子域名配置，它会优先被解析，而泛域名作为通配符规则，会匹配所有未显式定义的子域名。

#### 泛域名的应用场景

- **大规模系统**：对于需要管理大量子域名的企业或服务提供商，使用泛域名可以减少域名配置的复杂性。
- **负载均衡和高可用性**：在负载均衡或高可用性架构中，泛域名可以帮助简化流量转发和域名管理。
- **多租户环境**：在多租户系统中，泛域名可以用于为每个租户分配动态生成的子域名。

### **证书获取原理与挑战**

#### SSL/TLS 证书基础

在 HTTPS 通信中，SSL/TLS 证书用于加密通信并验证服务器身份。证书通常是与域名绑定的，并且包含公钥、签名等信息，用于建立安全的连接。

- **证书绑定**：每个 SSL/TLS 证书是绑定特定域名的，例如 `www.baidu.com` 的证书仅适用于 `www.baidu.com`，无法用于 `mail.baidu.com` 或其他子域名。
- **多证书服务器**：许多服务器同时支持多个域名和多个证书，在这种情况下，如何确保为客户端提供正确的证书成为一个问题。

#### SNI（Server Name Indication）

SNI 是 TLS 协议的一部分，允许客户端在建立 SSL/TLS 连接时，向服务器指明它希望连接的具体域名。服务器接收到该信息后，根据域名返回相应的证书。

- **SNI 的作用**：在一个 IP 地址上部署多个证书时，SNI 允许客户端告知服务器要连接的具体域名，从而获取正确的证书。
- **未使用 SNI 的情况**：如果客户端没有提供 SNI（例如，某些旧版客户端），服务器可能返回默认的证书，而这个证书可能不是客户端期望的。


### 4.泛域名验证流程
#### 生成随机子域名
以 *.baidu.com 为例，随机生成一个子域名，如 {timestamp}.baidu.com，以验证泛域名是否正常生效。
#### 配置 SNI
由于泛域名本身是一种规则，因此可以将其作为 SNI 规则进行配置。在面对不同域名场景的复杂性时，可以设计多种 SNI 配置方案，以确保能够覆盖不同的使用场景并兼容多种配置：
- 配置 SNI *.baidu.com：适用于所有以 baidu.com 为后缀的子域名，包括未显式配置的子域名。
- 配置 SNI baidu.com：用于指定根域名 baidu.com，适用于根域名本身的证书。
- 配置 SNI www.baidu.com：针对常见的 www 子域名进行配置，适用于该子域名特定的证书。
#### 验证证书
客户端可以通过以下步骤验证返回的证书：
- 验证证书链：确保证书链中的每个证书都有效，且最终证书由受信任的证书颁发机构（CA）签发。
- 域名匹配：确保证书中的 Subject 或 SAN（Subject Alternative Name）字段与客户端请求的域名匹配。


<br/>

:::info 👇👇👇
**本文作者:** 橙子昂 <br/>  
**版权声明:** 转载请注明出处哦~👮‍👮‍👮‍
:::